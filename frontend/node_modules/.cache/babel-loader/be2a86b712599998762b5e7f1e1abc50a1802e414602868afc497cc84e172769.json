{"ast":null,"code":"\"use strict\";\n\nvar __createBinding = this && this.__createBinding || (Object.create ? function (o, m, k, k2) {\n  if (k2 === undefined) k2 = k;\n  var desc = Object.getOwnPropertyDescriptor(m, k);\n  if (!desc || (\"get\" in desc ? !m.__esModule : desc.writable || desc.configurable)) {\n    desc = {\n      enumerable: true,\n      get: function () {\n        return m[k];\n      }\n    };\n  }\n  Object.defineProperty(o, k2, desc);\n} : function (o, m, k, k2) {\n  if (k2 === undefined) k2 = k;\n  o[k2] = m[k];\n});\nvar __setModuleDefault = this && this.__setModuleDefault || (Object.create ? function (o, v) {\n  Object.defineProperty(o, \"default\", {\n    enumerable: true,\n    value: v\n  });\n} : function (o, v) {\n  o[\"default\"] = v;\n});\nvar __importStar = this && this.__importStar || function (mod) {\n  if (mod && mod.__esModule) return mod;\n  var result = {};\n  if (mod != null) for (var k in mod) if (k !== \"default\" && Object.prototype.hasOwnProperty.call(mod, k)) __createBinding(result, mod, k);\n  __setModuleDefault(result, mod);\n  return result;\n};\nvar __importDefault = this && this.__importDefault || function (mod) {\n  return mod && mod.__esModule ? mod : {\n    \"default\": mod\n  };\n};\nObject.defineProperty(exports, \"__esModule\", {\n  value: true\n});\nexports.ProxyAgent = exports.proxies = void 0;\nconst http = __importStar(require(\"http\"));\nconst https = __importStar(require(\"https\"));\nconst url_1 = require(\"url\");\nconst lru_cache_1 = __importDefault(require(\"lru-cache\"));\nconst agent_base_1 = require(\"agent-base\");\nconst debug_1 = __importDefault(require(\"debug\"));\nconst proxy_from_env_1 = require(\"proxy-from-env\");\nconst debug = (0, debug_1.default)('proxy-agent');\n/**\n * Shorthands for built-in supported types.\n * Lazily loaded since some of these imports can be quite expensive\n * (in particular, pac-proxy-agent).\n */\nconst wellKnownAgents = {\n  http: async () => (await Promise.resolve().then(() => __importStar(require('http-proxy-agent')))).HttpProxyAgent,\n  https: async () => (await Promise.resolve().then(() => __importStar(require('https-proxy-agent')))).HttpsProxyAgent,\n  socks: async () => (await Promise.resolve().then(() => __importStar(require('socks-proxy-agent')))).SocksProxyAgent,\n  pac: async () => (await Promise.resolve().then(() => __importStar(require('pac-proxy-agent')))).PacProxyAgent\n};\n/**\n * Supported proxy types.\n */\nexports.proxies = {\n  http: [wellKnownAgents.http, wellKnownAgents.https],\n  https: [wellKnownAgents.http, wellKnownAgents.https],\n  socks: [wellKnownAgents.socks, wellKnownAgents.socks],\n  socks4: [wellKnownAgents.socks, wellKnownAgents.socks],\n  socks4a: [wellKnownAgents.socks, wellKnownAgents.socks],\n  socks5: [wellKnownAgents.socks, wellKnownAgents.socks],\n  socks5h: [wellKnownAgents.socks, wellKnownAgents.socks],\n  'pac+data': [wellKnownAgents.pac, wellKnownAgents.pac],\n  'pac+file': [wellKnownAgents.pac, wellKnownAgents.pac],\n  'pac+ftp': [wellKnownAgents.pac, wellKnownAgents.pac],\n  'pac+http': [wellKnownAgents.pac, wellKnownAgents.pac],\n  'pac+https': [wellKnownAgents.pac, wellKnownAgents.pac]\n};\nfunction isValidProtocol(v) {\n  return Object.keys(exports.proxies).includes(v);\n}\n/**\n * Uses the appropriate `Agent` subclass based off of the \"proxy\"\n * environment variables that are currently set.\n *\n * An LRU cache is used, to prevent unnecessary creation of proxy\n * `http.Agent` instances.\n */\nclass ProxyAgent extends agent_base_1.Agent {\n  constructor(opts) {\n    super(opts);\n    /**\n     * Cache for `Agent` instances.\n     */\n    this.cache = new lru_cache_1.default({\n      max: 20,\n      dispose: agent => agent.destroy()\n    });\n    debug('Creating new ProxyAgent instance: %o', opts);\n    this.connectOpts = opts;\n    this.httpAgent = opts?.httpAgent || new http.Agent(opts);\n    this.httpsAgent = opts?.httpsAgent || new https.Agent(opts);\n    this.getProxyForUrl = opts?.getProxyForUrl || proxy_from_env_1.getProxyForUrl;\n  }\n  async connect(req, opts) {\n    const {\n      secureEndpoint\n    } = opts;\n    const isWebSocket = req.getHeader('upgrade') === 'websocket';\n    const protocol = secureEndpoint ? isWebSocket ? 'wss:' : 'https:' : isWebSocket ? 'ws:' : 'http:';\n    const host = req.getHeader('host');\n    const url = new url_1.URL(req.path, `${protocol}//${host}`).href;\n    const proxy = await this.getProxyForUrl(url, req);\n    if (!proxy) {\n      debug('Proxy not enabled for URL: %o', url);\n      return secureEndpoint ? this.httpsAgent : this.httpAgent;\n    }\n    debug('Request URL: %o', url);\n    debug('Proxy URL: %o', proxy);\n    // attempt to get a cached `http.Agent` instance first\n    const cacheKey = `${protocol}+${proxy}`;\n    let agent = this.cache.get(cacheKey);\n    if (!agent) {\n      const proxyUrl = new url_1.URL(proxy);\n      const proxyProto = proxyUrl.protocol.replace(':', '');\n      if (!isValidProtocol(proxyProto)) {\n        throw new Error(`Unsupported protocol for proxy URL: ${proxy}`);\n      }\n      const ctor = await exports.proxies[proxyProto][secureEndpoint || isWebSocket ? 1 : 0]();\n      agent = new ctor(proxy, this.connectOpts);\n      this.cache.set(cacheKey, agent);\n    } else {\n      debug('Cache hit for proxy URL: %o', proxy);\n    }\n    return agent;\n  }\n  destroy() {\n    for (const agent of this.cache.values()) {\n      agent.destroy();\n    }\n    super.destroy();\n  }\n}\nexports.ProxyAgent = ProxyAgent;","map":{"version":3,"names":["http","__importStar","require","https","url_1","lru_cache_1","__importDefault","agent_base_1","debug_1","proxy_from_env_1","debug","default","wellKnownAgents","Promise","resolve","then","HttpProxyAgent","HttpsProxyAgent","socks","SocksProxyAgent","pac","PacProxyAgent","exports","proxies","socks4","socks4a","socks5","socks5h","isValidProtocol","v","Object","keys","includes","ProxyAgent","Agent","constructor","opts","cache","max","dispose","agent","destroy","connectOpts","httpAgent","httpsAgent","getProxyForUrl","connect","req","secureEndpoint","isWebSocket","getHeader","protocol","host","url","URL","path","href","proxy","cacheKey","get","proxyUrl","proxyProto","replace","Error","ctor","set","values"],"sources":["../src/index.ts"],"sourcesContent":[null],"mappings":";;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;AAAA,MAAAA,IAAA,GAAAC,YAAA,CAAAC,OAAA;AACA,MAAAC,KAAA,GAAAF,YAAA,CAAAC,OAAA;AACA,MAAAE,KAAA,GAAAF,OAAA;AACA,MAAAG,WAAA,GAAAC,eAAA,CAAAJ,OAAA;AACA,MAAAK,YAAA,GAAAL,OAAA;AACA,MAAAM,OAAA,GAAAF,eAAA,CAAAJ,OAAA;AACA,MAAAO,gBAAA,GAAAP,OAAA;AAYA,MAAMQ,KAAK,GAAG,IAAAF,OAAA,CAAAG,OAAW,EAAC,aAAa,CAAC;AAkBxC;;;;;AAKA,MAAMC,eAAe,GAAG;EACvBZ,IAAI,EAAE,MAAAA,CAAA,KAAY,CAAC,MAAAa,OAAA,CAAAC,OAAA,GAAAC,IAAA,OAAAd,YAAA,CAAAC,OAAA,CAAa,kBAAkB,GAAC,EAAEc,cAAc;EACnEb,KAAK,EAAE,MAAAA,CAAA,KAAY,CAAC,MAAAU,OAAA,CAAAC,OAAA,GAAAC,IAAA,OAAAd,YAAA,CAAAC,OAAA,CAAa,mBAAmB,GAAC,EAAEe,eAAe;EACtEC,KAAK,EAAE,MAAAA,CAAA,KAAY,CAAC,MAAAL,OAAA,CAAAC,OAAA,GAAAC,IAAA,OAAAd,YAAA,CAAAC,OAAA,CAAa,mBAAmB,GAAC,EAAEiB,eAAe;EACtEC,GAAG,EAAE,MAAAA,CAAA,KAAY,CAAC,MAAAP,OAAA,CAAAC,OAAA,GAAAC,IAAA,OAAAd,YAAA,CAAAC,OAAA,CAAa,iBAAiB,GAAC,EAAEmB;CAC1C;AAEV;;;AAGaC,OAAA,CAAAC,OAAO,GAKhB;EACHvB,IAAI,EAAE,CAACY,eAAe,CAACZ,IAAI,EAAEY,eAAe,CAACT,KAAK,CAAC;EACnDA,KAAK,EAAE,CAACS,eAAe,CAACZ,IAAI,EAAEY,eAAe,CAACT,KAAK,CAAC;EACpDe,KAAK,EAAE,CAACN,eAAe,CAACM,KAAK,EAAEN,eAAe,CAACM,KAAK,CAAC;EACrDM,MAAM,EAAE,CAACZ,eAAe,CAACM,KAAK,EAAEN,eAAe,CAACM,KAAK,CAAC;EACtDO,OAAO,EAAE,CAACb,eAAe,CAACM,KAAK,EAAEN,eAAe,CAACM,KAAK,CAAC;EACvDQ,MAAM,EAAE,CAACd,eAAe,CAACM,KAAK,EAAEN,eAAe,CAACM,KAAK,CAAC;EACtDS,OAAO,EAAE,CAACf,eAAe,CAACM,KAAK,EAAEN,eAAe,CAACM,KAAK,CAAC;EACvD,UAAU,EAAE,CAACN,eAAe,CAACQ,GAAG,EAAER,eAAe,CAACQ,GAAG,CAAC;EACtD,UAAU,EAAE,CAACR,eAAe,CAACQ,GAAG,EAAER,eAAe,CAACQ,GAAG,CAAC;EACtD,SAAS,EAAE,CAACR,eAAe,CAACQ,GAAG,EAAER,eAAe,CAACQ,GAAG,CAAC;EACrD,UAAU,EAAE,CAACR,eAAe,CAACQ,GAAG,EAAER,eAAe,CAACQ,GAAG,CAAC;EACtD,WAAW,EAAE,CAACR,eAAe,CAACQ,GAAG,EAAER,eAAe,CAACQ,GAAG;CACtD;AAED,SAASQ,eAAeA,CAACC,CAAS;EACjC,OAAOC,MAAM,CAACC,IAAI,CAACT,OAAA,CAAAC,OAAO,CAAC,CAACS,QAAQ,CAACH,CAAC,CAAC;AACxC;AA0BA;;;;;;;AAOA,MAAaI,UAAW,SAAQ1B,YAAA,CAAA2B,KAAK;EAcpCC,YAAYC,IAAwB;IACnC,KAAK,CAACA,IAAI,CAAC;IAdZ;;;IAGA,KAAAC,KAAK,GAAG,IAAIhC,WAAA,CAAAM,OAAQ,CAAgB;MACnC2B,GAAG,EAAE,EAAE;MACPC,OAAO,EAAGC,KAAK,IAAKA,KAAK,CAACC,OAAO;KACjC,CAAC;IASD/B,KAAK,CAAC,sCAAsC,EAAE0B,IAAI,CAAC;IACnD,IAAI,CAACM,WAAW,GAAGN,IAAI;IACvB,IAAI,CAACO,SAAS,GAAGP,IAAI,EAAEO,SAAS,IAAI,IAAI3C,IAAI,CAACkC,KAAK,CAACE,IAAI,CAAC;IACxD,IAAI,CAACQ,UAAU,GACdR,IAAI,EAAEQ,UAAU,IAAI,IAAIzC,KAAK,CAAC+B,KAAK,CAACE,IAA0B,CAAC;IAChE,IAAI,CAACS,cAAc,GAAGT,IAAI,EAAES,cAAc,IAAIpC,gBAAA,CAAAoC,cAAiB;EAChE;EAEA,MAAMC,OAAOA,CACZC,GAAuB,EACvBX,IAAsB;IAEtB,MAAM;MAAEY;IAAc,CAAE,GAAGZ,IAAI;IAC/B,MAAMa,WAAW,GAAGF,GAAG,CAACG,SAAS,CAAC,SAAS,CAAC,KAAK,WAAW;IAC5D,MAAMC,QAAQ,GAAGH,cAAc,GAC5BC,WAAW,GACV,MAAM,GACN,QAAQ,GACTA,WAAW,GACX,KAAK,GACL,OAAO;IACV,MAAMG,IAAI,GAAGL,GAAG,CAACG,SAAS,CAAC,MAAM,CAAC;IAClC,MAAMG,GAAG,GAAG,IAAIjD,KAAA,CAAAkD,GAAG,CAACP,GAAG,CAACQ,IAAI,EAAE,GAAGJ,QAAQ,KAAKC,IAAI,EAAE,CAAC,CAACI,IAAI;IAC1D,MAAMC,KAAK,GAAG,MAAM,IAAI,CAACZ,cAAc,CAACQ,GAAG,EAAEN,GAAG,CAAC;IAEjD,IAAI,CAACU,KAAK,EAAE;MACX/C,KAAK,CAAC,+BAA+B,EAAE2C,GAAG,CAAC;MAC3C,OAAOL,cAAc,GAAG,IAAI,CAACJ,UAAU,GAAG,IAAI,CAACD,SAAS;;IAGzDjC,KAAK,CAAC,iBAAiB,EAAE2C,GAAG,CAAC;IAC7B3C,KAAK,CAAC,eAAe,EAAE+C,KAAK,CAAC;IAE7B;IACA,MAAMC,QAAQ,GAAG,GAAGP,QAAQ,IAAIM,KAAK,EAAE;IACvC,IAAIjB,KAAK,GAAG,IAAI,CAACH,KAAK,CAACsB,GAAG,CAACD,QAAQ,CAAC;IACpC,IAAI,CAAClB,KAAK,EAAE;MACX,MAAMoB,QAAQ,GAAG,IAAIxD,KAAA,CAAAkD,GAAG,CAACG,KAAK,CAAC;MAC/B,MAAMI,UAAU,GAAGD,QAAQ,CAACT,QAAQ,CAACW,OAAO,CAAC,GAAG,EAAE,EAAE,CAAC;MACrD,IAAI,CAAClC,eAAe,CAACiC,UAAU,CAAC,EAAE;QACjC,MAAM,IAAIE,KAAK,CAAC,uCAAuCN,KAAK,EAAE,CAAC;;MAEhE,MAAMO,IAAI,GAAG,MAAM1C,OAAA,CAAAC,OAAO,CAACsC,UAAU,CAAC,CACrCb,cAAc,IAAIC,WAAW,GAAG,CAAC,GAAG,CAAC,CACrC,EAAE;MACHT,KAAK,GAAG,IAAIwB,IAAI,CAACP,KAAK,EAAE,IAAI,CAACf,WAAW,CAAC;MACzC,IAAI,CAACL,KAAK,CAAC4B,GAAG,CAACP,QAAQ,EAAElB,KAAK,CAAC;KAC/B,MAAM;MACN9B,KAAK,CAAC,6BAA6B,EAAE+C,KAAK,CAAC;;IAG5C,OAAOjB,KAAK;EACb;EAEAC,OAAOA,CAAA;IACN,KAAK,MAAMD,KAAK,IAAI,IAAI,CAACH,KAAK,CAAC6B,MAAM,EAAE,EAAE;MACxC1B,KAAK,CAACC,OAAO,EAAE;;IAEhB,KAAK,CAACA,OAAO,EAAE;EAChB;;AA3EDnB,OAAA,CAAAW,UAAA,GAAAA,UAAA","ignoreList":[]},"metadata":{},"sourceType":"script","externalDependencies":[]}