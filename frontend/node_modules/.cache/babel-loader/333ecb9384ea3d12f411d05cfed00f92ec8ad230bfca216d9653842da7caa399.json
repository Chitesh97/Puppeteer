{"ast":null,"code":"/**\n * @license\n * Copyright 2023 Google Inc.\n * SPDX-License-Identifier: Apache-2.0\n */\nimport { Connection } from '../cdp/Connection.js';\nimport { ProtocolError, UnsupportedOperation } from '../common/Errors.js';\nimport { debugError, DEFAULT_VIEWPORT } from '../common/util.js';\n/**\n * Users should never call this directly; it's called when calling `puppeteer.connect`\n * with `protocol: 'webDriverBiDi'`. This method attaches Puppeteer to an existing browser\n * instance. First it tries to connect to the browser using pure BiDi. If the protocol is\n * not supported, connects to the browser using BiDi over CDP.\n *\n * @internal\n */\nexport async function _connectToBiDiBrowser(connectionTransport, url, options) {\n  const {\n    acceptInsecureCerts = false,\n    networkEnabled = true,\n    defaultViewport = DEFAULT_VIEWPORT\n  } = options;\n  const {\n    bidiConnection,\n    cdpConnection,\n    closeCallback\n  } = await getBiDiConnection(connectionTransport, url, options);\n  const BiDi = await import(/* webpackIgnore: true */'./bidi.js');\n  const bidiBrowser = await BiDi.BidiBrowser.create({\n    connection: bidiConnection,\n    cdpConnection,\n    closeCallback,\n    process: undefined,\n    defaultViewport: defaultViewport,\n    acceptInsecureCerts: acceptInsecureCerts,\n    networkEnabled,\n    capabilities: options.capabilities\n  });\n  return bidiBrowser;\n}\n/**\n * Returns a BiDiConnection established to the endpoint specified by the options and a\n * callback closing the browser. Callback depends on whether the connection is pure BiDi\n * or BiDi over CDP.\n * The method tries to connect to the browser using pure BiDi protocol, and falls back\n * to BiDi over CDP.\n */\nasync function getBiDiConnection(connectionTransport, url, options) {\n  const BiDi = await import(/* webpackIgnore: true */'./bidi.js');\n  const {\n    slowMo = 0,\n    protocolTimeout\n  } = options;\n  // Try pure BiDi first.\n  const pureBidiConnection = new BiDi.BidiConnection(url, connectionTransport, slowMo, protocolTimeout);\n  try {\n    const result = await pureBidiConnection.send('session.status', {});\n    if ('type' in result && result.type === 'success') {\n      // The `browserWSEndpoint` points to an endpoint supporting pure WebDriver BiDi.\n      return {\n        bidiConnection: pureBidiConnection,\n        closeCallback: async () => {\n          await pureBidiConnection.send('browser.close', {}).catch(debugError);\n        }\n      };\n    }\n  } catch (e) {\n    if (!(e instanceof ProtocolError)) {\n      // Unexpected exception not related to BiDi / CDP. Rethrow.\n      throw e;\n    }\n  }\n  // Unbind the connection to avoid memory leaks.\n  pureBidiConnection.unbind();\n  // Fall back to CDP over BiDi reusing the WS connection.\n  const cdpConnection = new Connection(url, connectionTransport, slowMo, protocolTimeout, /* rawErrors= */true);\n  const version = await cdpConnection.send('Browser.getVersion');\n  if (version.product.toLowerCase().includes('firefox')) {\n    throw new UnsupportedOperation('Firefox is not supported in BiDi over CDP mode.');\n  }\n  const bidiOverCdpConnection = await BiDi.connectBidiOverCdp(cdpConnection);\n  return {\n    cdpConnection,\n    bidiConnection: bidiOverCdpConnection,\n    closeCallback: async () => {\n      // In case of BiDi over CDP, we need to close browser via CDP.\n      await cdpConnection.send('Browser.close').catch(debugError);\n    }\n  };\n}","map":{"version":3,"names":["Connection","ProtocolError","UnsupportedOperation","debugError","DEFAULT_VIEWPORT","_connectToBiDiBrowser","connectionTransport","url","options","acceptInsecureCerts","networkEnabled","defaultViewport","bidiConnection","cdpConnection","closeCallback","getBiDiConnection","BiDi","bidiBrowser","BidiBrowser","create","connection","process","undefined","capabilities","slowMo","protocolTimeout","pureBidiConnection","BidiConnection","result","send","type","catch","e","unbind","version","product","toLowerCase","includes","bidiOverCdpConnection","connectBidiOverCdp"],"sources":["/Users/goyac1/Desktop/Projects/puppeteer/node_modules/puppeteer-core/src/bidi/BrowserConnector.ts"],"sourcesContent":["/**\n * @license\n * Copyright 2023 Google Inc.\n * SPDX-License-Identifier: Apache-2.0\n */\n\nimport type {BrowserCloseCallback} from '../api/Browser.js';\nimport {Connection} from '../cdp/Connection.js';\nimport type {ConnectionTransport} from '../common/ConnectionTransport.js';\nimport type {ConnectOptions} from '../common/ConnectOptions.js';\nimport {ProtocolError, UnsupportedOperation} from '../common/Errors.js';\nimport {debugError, DEFAULT_VIEWPORT} from '../common/util.js';\n\nimport type {BidiBrowser} from './Browser.js';\nimport type {BidiConnection} from './Connection.js';\n\n/**\n * Users should never call this directly; it's called when calling `puppeteer.connect`\n * with `protocol: 'webDriverBiDi'`. This method attaches Puppeteer to an existing browser\n * instance. First it tries to connect to the browser using pure BiDi. If the protocol is\n * not supported, connects to the browser using BiDi over CDP.\n *\n * @internal\n */\nexport async function _connectToBiDiBrowser(\n  connectionTransport: ConnectionTransport,\n  url: string,\n  options: ConnectOptions,\n): Promise<BidiBrowser> {\n  const {\n    acceptInsecureCerts = false,\n    networkEnabled = true,\n    defaultViewport = DEFAULT_VIEWPORT,\n  } = options;\n\n  const {bidiConnection, cdpConnection, closeCallback} =\n    await getBiDiConnection(connectionTransport, url, options);\n  const BiDi = await import(/* webpackIgnore: true */ './bidi.js');\n  const bidiBrowser = await BiDi.BidiBrowser.create({\n    connection: bidiConnection,\n    cdpConnection,\n    closeCallback,\n    process: undefined,\n    defaultViewport: defaultViewport,\n    acceptInsecureCerts: acceptInsecureCerts,\n    networkEnabled,\n    capabilities: options.capabilities,\n  });\n  return bidiBrowser;\n}\n\n/**\n * Returns a BiDiConnection established to the endpoint specified by the options and a\n * callback closing the browser. Callback depends on whether the connection is pure BiDi\n * or BiDi over CDP.\n * The method tries to connect to the browser using pure BiDi protocol, and falls back\n * to BiDi over CDP.\n */\nasync function getBiDiConnection(\n  connectionTransport: ConnectionTransport,\n  url: string,\n  options: ConnectOptions,\n): Promise<{\n  cdpConnection?: Connection;\n  bidiConnection: BidiConnection;\n  closeCallback: BrowserCloseCallback;\n}> {\n  const BiDi = await import(/* webpackIgnore: true */ './bidi.js');\n  const {slowMo = 0, protocolTimeout} = options;\n\n  // Try pure BiDi first.\n  const pureBidiConnection = new BiDi.BidiConnection(\n    url,\n    connectionTransport,\n    slowMo,\n    protocolTimeout,\n  );\n  try {\n    const result = await pureBidiConnection.send('session.status', {});\n    if ('type' in result && result.type === 'success') {\n      // The `browserWSEndpoint` points to an endpoint supporting pure WebDriver BiDi.\n      return {\n        bidiConnection: pureBidiConnection,\n        closeCallback: async () => {\n          await pureBidiConnection.send('browser.close', {}).catch(debugError);\n        },\n      };\n    }\n  } catch (e) {\n    if (!(e instanceof ProtocolError)) {\n      // Unexpected exception not related to BiDi / CDP. Rethrow.\n      throw e;\n    }\n  }\n  // Unbind the connection to avoid memory leaks.\n  pureBidiConnection.unbind();\n\n  // Fall back to CDP over BiDi reusing the WS connection.\n  const cdpConnection = new Connection(\n    url,\n    connectionTransport,\n    slowMo,\n    protocolTimeout,\n    /* rawErrors= */ true,\n  );\n\n  const version = await cdpConnection.send('Browser.getVersion');\n  if (version.product.toLowerCase().includes('firefox')) {\n    throw new UnsupportedOperation(\n      'Firefox is not supported in BiDi over CDP mode.',\n    );\n  }\n\n  const bidiOverCdpConnection = await BiDi.connectBidiOverCdp(cdpConnection);\n  return {\n    cdpConnection,\n    bidiConnection: bidiOverCdpConnection,\n    closeCallback: async () => {\n      // In case of BiDi over CDP, we need to close browser via CDP.\n      await cdpConnection.send('Browser.close').catch(debugError);\n    },\n  };\n}\n"],"mappings":"AAAA;;;;;AAOA,SAAQA,UAAU,QAAO,sBAAsB;AAG/C,SAAQC,aAAa,EAAEC,oBAAoB,QAAO,qBAAqB;AACvE,SAAQC,UAAU,EAAEC,gBAAgB,QAAO,mBAAmB;AAK9D;;;;;;;;AAQA,OAAO,eAAeC,qBAAqBA,CACzCC,mBAAwC,EACxCC,GAAW,EACXC,OAAuB;EAEvB,MAAM;IACJC,mBAAmB,GAAG,KAAK;IAC3BC,cAAc,GAAG,IAAI;IACrBC,eAAe,GAAGP;EAAgB,CACnC,GAAGI,OAAO;EAEX,MAAM;IAACI,cAAc;IAAEC,aAAa;IAAEC;EAAa,CAAC,GAClD,MAAMC,iBAAiB,CAACT,mBAAmB,EAAEC,GAAG,EAAEC,OAAO,CAAC;EAC5D,MAAMQ,IAAI,GAAG,MAAM,MAAM,CAAC,yBAA0B,WAAW,CAAC;EAChE,MAAMC,WAAW,GAAG,MAAMD,IAAI,CAACE,WAAW,CAACC,MAAM,CAAC;IAChDC,UAAU,EAAER,cAAc;IAC1BC,aAAa;IACbC,aAAa;IACbO,OAAO,EAAEC,SAAS;IAClBX,eAAe,EAAEA,eAAe;IAChCF,mBAAmB,EAAEA,mBAAmB;IACxCC,cAAc;IACda,YAAY,EAAEf,OAAO,CAACe;GACvB,CAAC;EACF,OAAON,WAAW;AACpB;AAEA;;;;;;;AAOA,eAAeF,iBAAiBA,CAC9BT,mBAAwC,EACxCC,GAAW,EACXC,OAAuB;EAMvB,MAAMQ,IAAI,GAAG,MAAM,MAAM,CAAC,yBAA0B,WAAW,CAAC;EAChE,MAAM;IAACQ,MAAM,GAAG,CAAC;IAAEC;EAAe,CAAC,GAAGjB,OAAO;EAE7C;EACA,MAAMkB,kBAAkB,GAAG,IAAIV,IAAI,CAACW,cAAc,CAChDpB,GAAG,EACHD,mBAAmB,EACnBkB,MAAM,EACNC,eAAe,CAChB;EACD,IAAI;IACF,MAAMG,MAAM,GAAG,MAAMF,kBAAkB,CAACG,IAAI,CAAC,gBAAgB,EAAE,EAAE,CAAC;IAClE,IAAI,MAAM,IAAID,MAAM,IAAIA,MAAM,CAACE,IAAI,KAAK,SAAS,EAAE;MACjD;MACA,OAAO;QACLlB,cAAc,EAAEc,kBAAkB;QAClCZ,aAAa,EAAE,MAAAA,CAAA,KAAW;UACxB,MAAMY,kBAAkB,CAACG,IAAI,CAAC,eAAe,EAAE,EAAE,CAAC,CAACE,KAAK,CAAC5B,UAAU,CAAC;QACtE;OACD;IACH;EACF,CAAC,CAAC,OAAO6B,CAAC,EAAE;IACV,IAAI,EAAEA,CAAC,YAAY/B,aAAa,CAAC,EAAE;MACjC;MACA,MAAM+B,CAAC;IACT;EACF;EACA;EACAN,kBAAkB,CAACO,MAAM,EAAE;EAE3B;EACA,MAAMpB,aAAa,GAAG,IAAIb,UAAU,CAClCO,GAAG,EACHD,mBAAmB,EACnBkB,MAAM,EACNC,eAAe,EACf,gBAAiB,IAAI,CACtB;EAED,MAAMS,OAAO,GAAG,MAAMrB,aAAa,CAACgB,IAAI,CAAC,oBAAoB,CAAC;EAC9D,IAAIK,OAAO,CAACC,OAAO,CAACC,WAAW,EAAE,CAACC,QAAQ,CAAC,SAAS,CAAC,EAAE;IACrD,MAAM,IAAInC,oBAAoB,CAC5B,iDAAiD,CAClD;EACH;EAEA,MAAMoC,qBAAqB,GAAG,MAAMtB,IAAI,CAACuB,kBAAkB,CAAC1B,aAAa,CAAC;EAC1E,OAAO;IACLA,aAAa;IACbD,cAAc,EAAE0B,qBAAqB;IACrCxB,aAAa,EAAE,MAAAA,CAAA,KAAW;MACxB;MACA,MAAMD,aAAa,CAACgB,IAAI,CAAC,eAAe,CAAC,CAACE,KAAK,CAAC5B,UAAU,CAAC;IAC7D;GACD;AACH","ignoreList":[]},"metadata":{},"sourceType":"module","externalDependencies":[]}