{"ast":null,"code":"\"use strict\";\n\nvar __createBinding = this && this.__createBinding || (Object.create ? function (o, m, k, k2) {\n  if (k2 === undefined) k2 = k;\n  var desc = Object.getOwnPropertyDescriptor(m, k);\n  if (!desc || (\"get\" in desc ? !m.__esModule : desc.writable || desc.configurable)) {\n    desc = {\n      enumerable: true,\n      get: function () {\n        return m[k];\n      }\n    };\n  }\n  Object.defineProperty(o, k2, desc);\n} : function (o, m, k, k2) {\n  if (k2 === undefined) k2 = k;\n  o[k2] = m[k];\n});\nvar __setModuleDefault = this && this.__setModuleDefault || (Object.create ? function (o, v) {\n  Object.defineProperty(o, \"default\", {\n    enumerable: true,\n    value: v\n  });\n} : function (o, v) {\n  o[\"default\"] = v;\n});\nvar __importStar = this && this.__importStar || function (mod) {\n  if (mod && mod.__esModule) return mod;\n  var result = {};\n  if (mod != null) for (var k in mod) if (k !== \"default\" && Object.prototype.hasOwnProperty.call(mod, k)) __createBinding(result, mod, k);\n  __setModuleDefault(result, mod);\n  return result;\n};\nvar __importDefault = this && this.__importDefault || function (mod) {\n  return mod && mod.__esModule ? mod : {\n    \"default\": mod\n  };\n};\nObject.defineProperty(exports, \"__esModule\", {\n  value: true\n});\nexports.SocksProxyAgent = void 0;\nconst socks_1 = require(\"socks\");\nconst agent_base_1 = require(\"agent-base\");\nconst debug_1 = __importDefault(require(\"debug\"));\nconst dns = __importStar(require(\"dns\"));\nconst net = __importStar(require(\"net\"));\nconst tls = __importStar(require(\"tls\"));\nconst url_1 = require(\"url\");\nconst debug = (0, debug_1.default)('socks-proxy-agent');\nconst setServernameFromNonIpHost = options => {\n  if (options.servername === undefined && options.host && !net.isIP(options.host)) {\n    return {\n      ...options,\n      servername: options.host\n    };\n  }\n  return options;\n};\nfunction parseSocksURL(url) {\n  let lookup = false;\n  let type = 5;\n  const host = url.hostname;\n  // From RFC 1928, Section 3: https://tools.ietf.org/html/rfc1928#section-3\n  // \"The SOCKS service is conventionally located on TCP port 1080\"\n  const port = parseInt(url.port, 10) || 1080;\n  // figure out if we want socks v4 or v5, based on the \"protocol\" used.\n  // Defaults to 5.\n  switch (url.protocol.replace(':', '')) {\n    case 'socks4':\n      lookup = true;\n      type = 4;\n      break;\n    // pass through\n    case 'socks4a':\n      type = 4;\n      break;\n    case 'socks5':\n      lookup = true;\n      type = 5;\n      break;\n    // pass through\n    case 'socks':\n      // no version specified, default to 5h\n      type = 5;\n      break;\n    case 'socks5h':\n      type = 5;\n      break;\n    default:\n      throw new TypeError(`A \"socks\" protocol must be specified! Got: ${String(url.protocol)}`);\n  }\n  const proxy = {\n    host,\n    port,\n    type\n  };\n  if (url.username) {\n    Object.defineProperty(proxy, 'userId', {\n      value: decodeURIComponent(url.username),\n      enumerable: false\n    });\n  }\n  if (url.password != null) {\n    Object.defineProperty(proxy, 'password', {\n      value: decodeURIComponent(url.password),\n      enumerable: false\n    });\n  }\n  return {\n    lookup,\n    proxy\n  };\n}\nclass SocksProxyAgent extends agent_base_1.Agent {\n  constructor(uri, opts) {\n    super(opts);\n    const url = typeof uri === 'string' ? new url_1.URL(uri) : uri;\n    const {\n      proxy,\n      lookup\n    } = parseSocksURL(url);\n    this.shouldLookup = lookup;\n    this.proxy = proxy;\n    this.timeout = opts?.timeout ?? null;\n    this.socketOptions = opts?.socketOptions ?? null;\n  }\n  /**\n   * Initiates a SOCKS connection to the specified SOCKS proxy server,\n   * which in turn connects to the specified remote host and port.\n   */\n  async connect(req, opts) {\n    const {\n      shouldLookup,\n      proxy,\n      timeout\n    } = this;\n    if (!opts.host) {\n      throw new Error('No `host` defined!');\n    }\n    let {\n      host\n    } = opts;\n    const {\n      port,\n      lookup: lookupFn = dns.lookup\n    } = opts;\n    if (shouldLookup) {\n      // Client-side DNS resolution for \"4\" and \"5\" socks proxy versions.\n      host = await new Promise((resolve, reject) => {\n        // Use the request's custom lookup, if one was configured:\n        lookupFn(host, {}, (err, res) => {\n          if (err) {\n            reject(err);\n          } else {\n            resolve(res);\n          }\n        });\n      });\n    }\n    const socksOpts = {\n      proxy,\n      destination: {\n        host,\n        port: typeof port === 'number' ? port : parseInt(port, 10)\n      },\n      command: 'connect',\n      timeout: timeout ?? undefined,\n      // @ts-expect-error the type supplied by socks for socket_options is wider\n      // than necessary since socks will always override the host and port\n      socket_options: this.socketOptions ?? undefined\n    };\n    const cleanup = tlsSocket => {\n      req.destroy();\n      socket.destroy();\n      if (tlsSocket) tlsSocket.destroy();\n    };\n    debug('Creating socks proxy connection: %o', socksOpts);\n    const {\n      socket\n    } = await socks_1.SocksClient.createConnection(socksOpts);\n    debug('Successfully created socks proxy connection');\n    if (timeout !== null) {\n      socket.setTimeout(timeout);\n      socket.on('timeout', () => cleanup());\n    }\n    if (opts.secureEndpoint) {\n      // The proxy is connecting to a TLS server, so upgrade\n      // this socket connection to a TLS connection.\n      debug('Upgrading socket connection to TLS');\n      const tlsSocket = tls.connect({\n        ...omit(setServernameFromNonIpHost(opts), 'host', 'path', 'port'),\n        socket\n      });\n      tlsSocket.once('error', error => {\n        debug('Socket TLS error', error.message);\n        cleanup(tlsSocket);\n      });\n      return tlsSocket;\n    }\n    return socket;\n  }\n}\nSocksProxyAgent.protocols = ['socks', 'socks4', 'socks4a', 'socks5', 'socks5h'];\nexports.SocksProxyAgent = SocksProxyAgent;\nfunction omit(obj, ...keys) {\n  const ret = {};\n  let key;\n  for (key in obj) {\n    if (!keys.includes(key)) {\n      ret[key] = obj[key];\n    }\n  }\n  return ret;\n}","map":{"version":3,"names":["socks_1","require","agent_base_1","debug_1","__importDefault","dns","__importStar","net","tls","url_1","debug","default","setServernameFromNonIpHost","options","servername","undefined","host","isIP","parseSocksURL","url","lookup","type","hostname","port","parseInt","protocol","replace","TypeError","String","proxy","username","Object","defineProperty","value","decodeURIComponent","enumerable","password","SocksProxyAgent","Agent","constructor","uri","opts","URL","shouldLookup","timeout","socketOptions","connect","req","Error","lookupFn","Promise","resolve","reject","err","res","socksOpts","destination","command","socket_options","cleanup","tlsSocket","destroy","socket","SocksClient","createConnection","setTimeout","on","secureEndpoint","omit","once","error","message","protocols","exports","obj","keys","ret","key","includes"],"sources":["../src/index.ts"],"sourcesContent":[null],"mappings":"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","ignoreList":[]},"metadata":{},"sourceType":"script","externalDependencies":[]}